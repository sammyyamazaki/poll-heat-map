<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Einfluss markieren</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --input-w: 200px; }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #map { height: 100%; }
    .control-box {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      z-index: 1000; background: #f0f0f0; padding: 10px 14px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3); display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
    }
    #address {
      width: var(--input-w); max-width: var(--input-w); box-sizing: border-box;
      padding: 6px; font-size: 14px; background: #fff;
      border: 1px solid #bbb; border-radius: 4px; -webkit-appearance: none; appearance: none;
    }
    #searchBtn {
      padding: 6px 10px; font-size: 14px; background: #333; color: #fff;
      border: 1px solid #444; border-radius: 4px; cursor: pointer;
    }
    #searchBtn:hover { background: #555; }
    .circle-choice-group { display: flex; gap: 10px; align-items: center; }
    .circle-choice {
      display: flex; align-items: center; justify-content: center;
      border: 3px solid #ccc; background-color: #ddd; cursor: pointer;
      transition: 0.2s; border-radius: 50%;
    }
    .circle-choice.active { border-color: #ff5555; background-color: #d44; }
    .circle-choice[data-size="1"] { width: 22px; height: 22px; }
    .circle-choice[data-size="2"] { width: 36px; height: 36px; }
    .circle-choice[data-size="3"] { width: 58px; height: 58px; }

    @media (max-width: 600px) {
      :root { --input-w: 100%; }
      .control-box { flex-direction: column; align-items: stretch; }
      #searchBtn { width: 100%; }
      .circle-choice-group { justify-content: center; }
    }

    /* Suggestions aligned to input width */
    .suggest {
      position: absolute; top: calc(100% + 6px); left: 0;
      z-index: 1001;
      width: 100%;
      min-width: 100%;
      max-width: 100%;
      max-height: 300px;
      overflow: auto;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .suggest.hidden { display: none; }
    .suggest-item { padding: 8px 10px; cursor: pointer; }
    .suggest-item:hover { background: #f3f4f6; }

    .splash {
      position: fixed; inset: 0; background: #000; color: #fff;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 10px; z-index: 2000; opacity: 1; transition: opacity .5s ease;
    }
    .splash.hidden { opacity: 0; pointer-events: none; }
    .splash img { max-width: 220px; height: auto; }
    .splash .claim { font-size: 18px; opacity: .9; }
  
    .size-wrap { display:flex; align-items:center; gap:10px; }
    #sizeSlider { width: 200px; }
    .size-label { font-size: 14px; color: #111; min-width: 80px; }
    .address-wrap { position: relative; width: var(--input-w); max-width: var(--input-w); }
    .address-wrap > #address { width: 100%; }
    .suggest {
      position: absolute; top: calc(100% + 6px); left: 0;
      z-index: 1001;
      width: 100%;
      min-width: 100%;
      max-width: 100%;
      max-height: 300px;
      overflow: auto;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .suggest-item { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; }
    .suggest-item:last-child { border-bottom: 0; }
    .suggest-item:hover { background: #f9fafb; }

  
    /* enhanced suggest styles */
    .address-wrap { position: relative; display: inline-block; width: 100%; max-width: var(--input-w); }
    .address-wrap > #address { width: 100%; }
    .suggest {
      position: absolute; top: calc(100% + 6px); left: 0;
      z-index: 1001;
      width: 100%;
      min-width: 100%;
      max-width: 100%;
      max-height: 300px;
      overflow: auto;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .suggest.hidden { display: none; }
    .suggest-item { padding: 10px 12px; cursor: pointer; display: grid; gap: 2px; }
    .suggest-item + .suggest-item { border-top: 1px solid #f1f5f9; }
    .suggest-item:hover { background: #f8fafc; }
    .suggest-item .primary { font-size: 14px; line-height: 1.2; font-weight: 600; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .suggest-item .secondary { font-size: 12px; line-height: 1.2; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body>
  <div class="control-box">
  <input type="range" id="sizeSlider" min="1" max="5" step="0.1" value="2" aria-label="Größe des Einflusses" />
  <div class="address-wrap">
    <input id="address" type="text" placeholder="Adresse suchen…" autocomplete="off" />
    <div id="suggest" class="suggest hidden"></div>
  </div>
  <button id="searchBtn">Senden</button>
</div>
<div id="map"></div>
<div id="splash" class="splash">
    <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
    <div class="claim">Los geht's!</div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const socket = io();
    const map = L.map('map').setView([51.4566, 7.0123], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CARTO', subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    const splash = document.getElementById('splash');
function hideSplash() {
  if (!splash) return;
  splash.classList.add('hidden');
  setTimeout(() => splash.remove(), 600);
}
window.addEventListener('load', () => {
  setTimeout(hideSplash, 2000);
});
if (splash) {
  splash.addEventListener('click', hideSplash);
  splash.addEventListener('touchstart', hideSplash, { passive: true });
}

let selectedSize = 2.0;
const sizeSlider = document.getElementById('sizeSlider');
const updateSize = () => { selectedSize = parseFloat(sizeSlider.value); };
sizeSlider.addEventListener('input', updateSize);
updateSize();

let lastPinAt = 0;
    function placePin(lat, lon) {
      const now = Date.now();
      if (now - lastPinAt < 500) return;
      lastPinAt = now;
      socket.emit('newPin', { lat, lon, size: selectedSize });
      L.circleMarker([lat, lon], {
        radius: selectedSize * 5, color: 'red', fillColor: '#f88', fillOpacity: 0.5, weight: 2
      }).addTo(map);
    }

    document.getElementById('searchBtn').onclick = async () => {
      const q = document.getElementById('address').value.trim();
      if (!q) return;
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=8`;
      const res = await fetch(url, { headers: { 'Accept-Language': 'de' }});
      const data = await res.json();
      if (data.length > 0) {
        const { lat, lon } = data[0];
        map.setView([+lat, +lon], 14);
        placePin(+lat, +lon);
      }
    };

    const suggestBox = document.getElementById('suggest');
    let suggestTimer = null;
    let suggestController = null;
    function hideSuggest(){
      if (suggestTimer) { clearTimeout(suggestTimer); suggestTimer = null; }
      if (suggestController) { try { suggestController.abort(); } catch {} suggestController = null; }
      suggestBox.classList.add('hidden');
      suggestBox.innerHTML = '';
    }
    document.getElementById('address').addEventListener('input', (e) => {
      const q = e.target.value.trim();
      clearTimeout(suggestTimer);
      if (!q) {
        suggestBox.classList.add('hidden');
        suggestBox.innerHTML = '';
        return;
      }
      suggestTimer = setTimeout(async () => {
        try {
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=8`;
          const res = await fetch(url, { headers: { 'Accept-Language': 'de' }});
          const list = await res.json();
          if (!Array.isArray(list) || list.length === 0) {
            suggestBox.classList.add('hidden');
            suggestBox.innerHTML = '';
            return;
          }
          suggestBox.innerHTML = list.map(item => {
            const a = item.address || {};
            const road = a.road || a.pedestrian || a.footway || a.path || a.residential || a.cycleway || '';
            const house = a.house_number || '';
            const city = a.city || a.town || a.village || '';
            const primary = road ? (house ? `${road} ${house}` : road) : (item.name || city || 'Ort');
            const secondary = city;
            return `<div class="suggest-item" data-lat="${item.lat}" data-lon="${item.lon}">
                      <div class="primary">${primary}</div>
                      <div class="secondary">${secondary}</div>
                    </div>`;
          }).join('');
          suggestBox.classList.remove('hidden');
        } catch {
          suggestBox.classList.add('hidden');
          suggestBox.innerHTML = '';
        }
      }, 300);
    });

    suggestBox.addEventListener('click', (e) => {
      const el = e.target.closest('.suggest-item');
      if (!el) return;
      const lat = parseFloat(el.dataset.lat);
      const lon = parseFloat(el.dataset.lon);
      map.setView([lat, lon], 14);
      placePin(lat, lon);
      // Always hide and clear suggestions after selection
      suggestBox.innerHTML = '';
      suggestBox.classList.add('hidden');
      document.getElementById('address').value = '';
suggestBox.classList.add('hidden');
      suggestBox.innerHTML = '';
      document.getElementById('address').value = '';
    });

    document.getElementById('address').addEventListener('blur', () => { setTimeout(hideSuggest, 150); });
    document.getElementById('address').addEventListener('keydown', (e) => { if (e.key === 'Escape') hideSuggest(); });
    document.addEventListener('click', (e) => { const wrap = document.querySelector('.address-wrap'); if (!wrap) return; if (!wrap.contains(e.target) && !suggestBox.contains(e.target)) hideSuggest(); });

    map.on('click', e => placePin(e.latlng.lat, e.latlng.lng));

    socket.on('pinRejected', ({ reason }) => {
      if (reason === 'too_fast') console.warn('Bitte kurz warten (Entprellung).');
      else if (reason === 'rate_limit') alert('Zu viele Einträge in kurzer Zeit. Bitte kurz warten.');
    });
  </script>
</body>
</html>