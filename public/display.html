
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leinwand</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root{
      --panel-w: 340px;
      --bg: rgba(255,255,255,0.75);
      --border: rgba(0,0,0,0.08);
      --shadow: 0 8px 30px rgba(0,0,0,0.15);
      --accent: #2563eb;
      --accent-2: #ef4444;
      --text: #0f172a;
      --muted: #64748b;
      --radius: 16px;
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color: var(--text); }
    #map { height: 100%; }

    .toggle-btn{
      position: absolute; right: 16px; top: 16px;
      z-index: 1003; width: 46px; height: 46px; border-radius: 50%;
      background: var(--bg); border: 1px solid var(--border); backdrop-filter: blur(8px);
      box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform .15s ease, background .15s ease, opacity .15s ease;
    }
    .toggle-btn:hover{ transform: scale(1.04); background: rgba(255,255,255,0.85); }
    .toggle-btn svg{ width: 22px; height: 22px; opacity: .9; }
    .toggle-btn.hidden { opacity: 0; pointer-events: none; }

    .sidebar{
      position: absolute; right: 16px; top: 16px; bottom: 16px; width: var(--panel-w);
      background: var(--bg); border: 1px solid var(--border); backdrop-filter: blur(10px);
      box-shadow: var(--shadow); border-radius: var(--radius);
      z-index: 1002; display: flex; flex-direction: column; overflow: hidden;
      transform: translateX(0); transition: transform .25s ease;
    }
    .sidebar.hidden{ transform: translateX(calc(100% + 16px)); }
    .sidebar .header{
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.6);
    }
    .title{ font-weight: 600; letter-spacing: .2px; }
    .close-btn{
      width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border);
      background: white; display:flex; align-items:center; justify-content:center; cursor:pointer;
      transition: transform .12s ease, background .15s ease;
    }
    .close-btn:hover{ transform: scale(1.04); background: #f8fafc; }
    .close-btn svg{ width: 18px; height: 18px; }

    .content{ padding: 14px; overflow: auto; display: grid; gap: 14px; }
    .card{
      background: rgba(255,255,255,0.7); border: 1px solid var(--border); border-radius: 12px; padding: 12px;
    }
    .card h4{ margin: 0 0 8px; font-size: 13px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); }
    .row{ display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .row > * { flex: 1 1 auto; }

    select, button, input[type="range"]{
      font: inherit; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #fff;
    }
    select{ width: 100%; }
    .segmented{
      display: inline-flex; background: #fff; border:1px solid var(--border); border-radius: 10px; overflow:hidden;
    }
    .segmented label{
      padding: 8px 10px; cursor: pointer; display:flex; align-items:center; gap:6px; user-select: none;
      border-right: 1px solid var(--border); font-size: 14px;
    }
    .segmented label:last-child{ border-right: none; }
    .segmented input{ accent-color: var(--accent); }

    .badge{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding: 6px 10px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-size: 12px;
      border: 1px solid var(--border);
    }
    .btn{
      border: 1px solid var(--border); background: #111827; color: #fff;
      border-radius: 12px; padding: 10px 12px; cursor:pointer; transition: transform .1s ease, opacity .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); opacity: .95; }
    .btn.secondary{ background: #fff; color: #111827; }
    .btn.warn{ background: var(--accent-2); }

    .footer-actions{ display:flex; gap:10px; }

    @media (max-width: 760px){
      :root{ --panel-w: min(92vw, 360px); }
      .toggle-btn{ right: 10px; top: 10px; }
      .sidebar{ right: 10px; left: 10px; width: auto; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <button id="toggleBtn" class="toggle-btn" aria-label="Bedienfeld öffnen">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
  </button>

  <aside id="sidebar" class="sidebar hidden">
    <div class="header">
      <div class="title">Anzeige & Steuerung</div>
      <button id="closePanel" class="close-btn" aria-label="Minimieren">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="content">
      <div class="card">
        <h4>Basemap</h4>
        <select id="basemap">
          <option value="positron" selected>CartoDB Positron</option>
          <option value="voyager">CartoDB Voyager</option>
          <option value="osmde">OSM DE</option>
          <option value="osmstd">OSM Standard</option>
          <option value="tonerlite">Stamen Toner Lite</option>
        </select>
      </div>

      <div class="card">
        <h4>Ansicht</h4>
        <div class="segmented">
          <label><input type="radio" name="mode" value="heat" checked> Heatmap</label>
          <label><input type="radio" name="mode" value="cluster"> Cluster</label>
          <label><input type="radio" name="mode" value="both"> Beides</label>
        </div>
      </div>

      <div class="card">
        <h4>Heatmap</h4>
        <div class="row">
          <label style="flex:0 0 90px; color:var(--muted); font-size:13px;">Intensität</label>
          <input id="intensity" type="range" min="0.5" max="2.5" value="1.5" step="0.1">
        </div>
      </div>

      <div class="card">
        <h4>Status</h4>
        <div class="row">
          <span class="badge" id="count">0 Pins</span>
          <button id="fitBtn" class="btn secondary" style="margin-left:auto;">Fit to Pins</button>
        </div>
      </div>

      <div class="card">
        <h4>Export</h4>
        <div class="row">
          <select id="exportSelect">
            <option value="geojson">GeoJSON (.geojson)</option>
            <option value="csv">CSV (.csv)</option>
            <option value="kml">KML (.kml)</option>
            <option value="gpx">GPX (.gpx)</option>
          </select>
          <button id="exportBtn" class="btn">Download</button>
        </div>
      </div>

      <div class="footer-actions">
        <button id="resetBtn" class="btn warn" style="margin-left:auto;">Reset</button>
      </div>
    </div>
  </aside>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    // Sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleBtn');
    const closePanel = document.getElementById('closePanel');
    function openSidebar(){ sidebar.classList.remove('hidden'); toggleBtn.classList.add('hidden'); }
    function closeSidebar(){ sidebar.classList.add('hidden'); toggleBtn.classList.remove('hidden'); }
    toggleBtn.addEventListener('click', openSidebar);
    closePanel.addEventListener('click', closeSidebar);

    // Map & layers
    const socket = io();
    const map = L.map('map', { zoomControl: true }).setView([51.4566, 7.0123], 12);

    const basemaps = {
      positron: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CARTO', subdomains: 'abcd', maxZoom: 20 }),
      voyager:  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CARTO', subdomains: 'abcd', maxZoom: 20 }),
      osmde:    L.tileLayer('https://tile.openstreetmap.de/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap', maxZoom: 19 }),
      osmstd:   L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap', maxZoom: 19 }),
      tonerlite:L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', { attribution: '&copy; Stamen & OpenStreetMap', maxZoom: 20 })
    };
    let currentBase = basemaps.positron.addTo(map);
    document.getElementById('basemap').addEventListener('change', (e) => {
      const val = e.target.value;
      if (basemaps[val]) { map.removeLayer(currentBase); currentBase = basemaps[val].addTo(map); }
    });

    // Heat settings (boosted + clamped)
    const HEAT_BASE_METERS = 420;
    const HEAT_BLUR_RATIO = 0.55;
    const HEAT_MIN_PX = 18, HEAT_MAX_PX = 60;
    function weightForSize(s){ s = Math.max(1, Math.min(5, parseFloat(s||2))); const k = 0.5; return Math.min(5, Math.exp(k*(s-1))); }
    let intensityFactor = 1.5;

    const heat = L.heatLayer([], {
      radius: 30, blur: 16, maxZoom: 18, minOpacity: 0.35, max: 1.4,
      gradient: { 0.0:'#a5b4fc', 0.4:'#60a5fa', 0.7:'#34d399', 0.85:'#f59e0b', 1.0:'#ef4444' }
    });

    function metersToPixels(m, lat, zoom) {
      const mpp = 156543.03392 * Math.cos(lat * Math.PI/180) / Math.pow(2, zoom);
      return m / mpp;
    }
    function updateHeatRadius() {
      const z = map.getZoom();
      const lat = map.getCenter().lat;
      let rPx = Math.round(metersToPixels(HEAT_BASE_METERS, lat, z));
      rPx = Math.max(HEAT_MIN_PX, Math.min(HEAT_MAX_PX, rPx));
      heat.setOptions({ radius: rPx, blur: Math.round(rPx * HEAT_BLUR_RATIO) });
    }
    function recomputeHeatPoints() {
      const pts = pins.map(p => [p.lat, p.lon, weightForSize(p.size) * intensityFactor]);
      heat.setLatLngs(pts);
    }

    function pinToMarker(p) {
      const s = Math.max(1, Math.min(5, parseFloat(p.size || 2)));
      const px = s * 6;
      return L.marker([p.lat, p.lon], {
        icon: L.divIcon({
          className: 'pin',
          html: '<div style="width:'+ px +'px;height:'+ px +'px;border-radius:50%;border:2px solid #ef4444;background:rgba(239,68,68,0.5)"></div>',
          iconSize: [px, px], iconAnchor: [px/2, px/2]
        })
      });
    }
    const clusters = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 60 });

    const pins = [];
    const countEl = document.getElementById('count');
    function updateCount() { countEl.textContent = pins.length + ' Pins'; }

    function renderAll() {
      recomputeHeatPoints();
      clusters.clearLayers();
      clusters.addLayers(pins.map(pinToMarker));
      applyMode(currentMode());
      updateCount();
      updateHeatRadius();
    }

    function addPin(p) {
      pins.push(p);
      recomputeHeatPoints();
      clusters.addLayer(pinToMarker(p));
      updateCount();
      updateHeatRadius();
    }

    function currentMode() { return document.querySelector('input[name="mode"]:checked').value; }
    function applyMode(mode) {
      map.removeLayer(heat);
      map.removeLayer(clusters);
      if (mode === 'heat') heat.addTo(map);
      else if (mode === 'cluster') clusters.addTo(map);
      else { heat.addTo(map); clusters.addTo(map); }
    }

    function fitToPins() {
      if (pins.length === 0) return;
      const latlngs = pins.map(p => [p.lat, p.lon]);
      map.fitBounds(latlngs, { padding: [40, 40] });
    }
    document.getElementById('fitBtn').addEventListener('click', fitToPins);

    document.getElementById('exportBtn').addEventListener('click', () => {
      const ext = document.getElementById('exportSelect').value;
      const href = ext === 'geojson' ? '/pins.geojson'
                 : ext === 'csv'     ? '/pins.csv'
                 : ext === 'kml'     ? '/pins.kml'
                 : '/pins.gpx';
      window.open(href, '_blank');
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      const pw = prompt('Reset-Passwort:');
      if (!pw) return;
      fetch('/reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pw }) })
        .then(res => { if (!res.ok) alert('Ungültiges Passwort!'); });
    });

    socket.on('init', (arr) => { arr.forEach(p => pins.push(p)); renderAll(); });
    socket.on('pinAdded', addPin);
    socket.on('reset', () => { pins.length = 0; heat.setLatLngs([]); clusters.clearLayers(); updateCount(); updateHeatRadius(); });

    document.getElementById('intensity').addEventListener('input', (e) => {
      intensityFactor = parseFloat(e.target.value || '1.5');
      recomputeHeatPoints();
    });
    document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener('change', () => applyMode(currentMode())));
    applyMode('heat');
    map.on('zoomend moveend', () => { updateHeatRadius(); });
  </script>
</body>
</html>
